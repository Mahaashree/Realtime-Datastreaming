<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Speed Monitoring Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background-color: #10b981;
            box-shadow: 0 0 8px #10b981;
        }

        .status-offline {
            background-color: #ef4444;
            box-shadow: 0 0 8px #ef4444;
        }

        .status-unknown {
            background-color: #6b7280;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chart-speed {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 200px;
        }

        .data-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .data-table h2 {
            margin-bottom: 15px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            border-left: 4px solid #10b981;
        }

        .connection-status.disconnected {
            border-left: 4px solid #ef4444;
        }

        .telemetry-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .telemetry-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            background: #f9fafb;
            border-radius: 4px;
        }

        .telemetry-label {
            color: #6b7280;
            font-weight: 500;
        }

        .telemetry-value {
            color: #333;
            font-weight: 600;
        }

        .detection-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .detection-normal {
            background-color: #d1fae5;
            color: #065f46;
        }

        .detection-alert {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .detection-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš— Vehicle Speed Monitoring Dashboard</h1>
            <p>Real-time data streaming from 10 vehicle devices</p>
            <div class="status-bar" id="statusBar">
                <!-- Device status indicators will be inserted here -->
            </div>
        </div>

        <div class="connection-status disconnected" id="connectionStatus">
            <span class="status-indicator" id="connectionIndicator"></span>
            <span id="connectionText">Connecting...</span>
        </div>

        <div class="charts-grid" id="chartsGrid">
            <!-- Charts will be inserted here -->
        </div>

        <div class="data-table">
            <h2>Device Data Overview</h2>
            <table>
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Status</th>
                        <th>Speed (km/h)</th>
                        <th>CPU %</th>
                        <th>RAM %</th>
                        <th>Detection</th>
                        <th>Last Update</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Table rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        const charts = {};
        const deviceData = {};
        const MAX_DATA_POINTS = 50;

        // Connection status
        socket.on('connect', () => {
            document.getElementById('connectionStatus').classList.remove('disconnected');
            document.getElementById('connectionStatus').classList.add('connected');
            document.getElementById('connectionIndicator').classList.add('status-online');
            document.getElementById('connectionText').textContent = 'Connected';
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').classList.remove('connected');
            document.getElementById('connectionStatus').classList.add('disconnected');
            document.getElementById('connectionIndicator').classList.remove('status-online');
            document.getElementById('connectionText').textContent = 'Disconnected';
        });

        // Initialize charts for 10 devices
        function initializeCharts() {
            const chartsGrid = document.getElementById('chartsGrid');
            
            for (let i = 1; i <= 10; i++) {
                const deviceId = `vehicle_${String(i).padStart(2, '0')}`;
                
                // Create chart card
                const card = document.createElement('div');
                card.className = 'chart-card';
                card.id = `card-${deviceId}`;
                
                card.innerHTML = `
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">${deviceId}</div>
                            <div class="chart-speed" id="speed-${deviceId}">-- km/h</div>
                            <div class="detection-badge detection-normal" id="detection-${deviceId}">Normal</div>
                        </div>
                        <span class="status-indicator status-unknown" id="status-${deviceId}"></span>
                    </div>
                    <div class="telemetry-info" id="telemetry-${deviceId}">
                        <div class="telemetry-item">
                            <span class="telemetry-label">CPU:</span>
                            <span class="telemetry-value" id="cpu-${deviceId}">--%</span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">RAM:</span>
                            <span class="telemetry-value" id="ram-${deviceId}">--%</span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">Memory:</span>
                            <span class="telemetry-value" id="memory-${deviceId}">--%</span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">Disk:</span>
                            <span class="telemetry-value" id="disk-${deviceId}">--%</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-${deviceId}"></canvas>
                    </div>
                `;
                
                chartsGrid.appendChild(card);
                
                // Initialize Chart.js
                const ctx = document.getElementById(`chart-${deviceId}`).getContext('2d');
                charts[deviceId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Speed (km/h)',
                            data: [],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 120,
                                title: {
                                    display: true,
                                    text: 'Speed (km/h)'
                                }
                            },
                            x: {
                                display: false
                            }
                        },
                        animation: {
                            duration: 300
                        }
                    }
                });
                
                deviceData[deviceId] = {
                    speeds: [],
                    timestamps: [],
                    status: 'unknown',
                    cpu_usage: undefined,
                    ram_usage: undefined,
                    memory_percent: undefined,
                    disk_percent: undefined,
                    detection_label: 'normal'
                };
            }
        }

        // Update chart with new data
        function updateChart(deviceId, speed, timestamp) {
            if (!charts[deviceId]) return;
            
            const chart = charts[deviceId];
            const data = deviceData[deviceId];
            
            // Add new data point
            data.speeds.push(speed);
            data.timestamps.push(new Date(timestamp * 1000).toLocaleTimeString());
            
            // Keep only last MAX_DATA_POINTS
            if (data.speeds.length > MAX_DATA_POINTS) {
                data.speeds.shift();
                data.timestamps.shift();
            }
            
            // Update chart
            chart.data.labels = data.timestamps;
            chart.data.datasets[0].data = data.speeds;
            chart.update('none'); // Update without animation for performance
            
            // Update speed display
            document.getElementById(`speed-${deviceId}`).textContent = `${speed.toFixed(1)} km/h`;
        }

        // Update device status
        function updateDeviceStatus(deviceId, status) {
            const indicator = document.getElementById(`status-${deviceId}`);
            if (indicator) {
                indicator.className = 'status-indicator';
                if (status === 'online') {
                    indicator.classList.add('status-online');
                } else if (status === 'offline') {
                    indicator.classList.add('status-offline');
                } else {
                    indicator.classList.add('status-unknown');
                }
            }
            
            if (deviceData[deviceId]) {
                deviceData[deviceId].status = status;
            }
        }

        // Update status bar
        function updateStatusBar() {
            const statusBar = document.getElementById('statusBar');
            statusBar.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const deviceId = `vehicle_${String(i).padStart(2, '0')}`;
                const status = deviceData[deviceId]?.status || 'unknown';
                
                const item = document.createElement('div');
                item.className = 'status-item';
                item.innerHTML = `
                    <span class="status-indicator ${status === 'online' ? 'status-online' : status === 'offline' ? 'status-offline' : 'status-unknown'}"></span>
                    <span>${deviceId}</span>
                `;
                statusBar.appendChild(item);
            }
        }

        // Update data table
        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            const devices = Object.keys(deviceData).sort();
            
            devices.forEach(deviceId => {
                const data = deviceData[deviceId];
                const latestSpeed = data.speeds.length > 0 ? data.speeds[data.speeds.length - 1] : '--';
                const latestTimestamp = data.timestamps.length > 0 ? data.timestamps[data.timestamps.length - 1] : '--';
                const cpu = data.cpu_usage !== undefined ? data.cpu_usage.toFixed(1) : '--';
                const ram = data.ram_usage !== undefined ? data.ram_usage.toFixed(1) : '--';
                const detection = data.detection_label || 'normal';
                const detectionText = detection.charAt(0).toUpperCase() + detection.slice(1).replace('_', ' ');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${deviceId}</td>
                    <td>
                        <span class="status-indicator ${data.status === 'online' ? 'status-online' : data.status === 'offline' ? 'status-offline' : 'status-unknown'}"></span>
                        ${data.status}
                    </td>
                    <td>${latestSpeed === '--' ? '--' : latestSpeed.toFixed(1)}</td>
                    <td>${cpu}%</td>
                    <td>${ram}%</td>
                    <td>
                        <span class="detection-badge ${detection === 'normal' ? 'detection-normal' : detection === 'eyes_closed' || detection === 'drowsy' ? 'detection-warning' : 'detection-alert'}">
                            ${detectionText}
                        </span>
                    </td>
                    <td>${latestTimestamp}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update telemetry display
        function updateTelemetry(deviceId, data) {
            const cpuEl = document.getElementById(`cpu-${deviceId}`);
            const ramEl = document.getElementById(`ram-${deviceId}`);
            const memoryEl = document.getElementById(`memory-${deviceId}`);
            const diskEl = document.getElementById(`disk-${deviceId}`);
            
            if (cpuEl && data.cpu_usage !== undefined) {
                cpuEl.textContent = `${data.cpu_usage.toFixed(1)}%`;
            }
            if (ramEl && data.ram_usage !== undefined) {
                ramEl.textContent = `${data.ram_usage.toFixed(1)}%`;
            }
            if (memoryEl && data.memory_percent !== undefined) {
                memoryEl.textContent = `${data.memory_percent.toFixed(1)}%`;
            }
            if (diskEl && data.disk_percent !== undefined) {
                diskEl.textContent = `${data.disk_percent.toFixed(1)}%`;
            }
        }

        // Update detection label display
        function updateDetection(deviceId, detectionLabel) {
            const badge = document.getElementById(`detection-${deviceId}`);
            if (!badge) return;
            
            const label = detectionLabel || "normal";
            const labelText = label.charAt(0).toUpperCase() + label.slice(1).replace('_', ' ');
            
            // Remove all detection classes
            badge.className = 'detection-badge';
            
            // Add appropriate class based on label
            if (label === "normal") {
                badge.classList.add('detection-normal');
                badge.textContent = 'Normal';
            } else if (label === "eyes_closed" || label === "drowsy") {
                badge.classList.add('detection-warning');
                badge.textContent = labelText;
            } else {
                badge.classList.add('detection-alert');
                badge.textContent = labelText;
            }
        }

        // Handle latest data from WebSocket
        socket.on('latest_data', (data) => {
            Object.keys(data).forEach(deviceId => {
                const deviceInfo = data[deviceId];
                const speed = deviceInfo.speed;
                const timestamp = deviceInfo.timestamp;
                const detectionLabel = deviceInfo.detection_label;
                
                // Store telemetry data
                if (deviceData[deviceId]) {
                    if (deviceInfo.cpu_usage !== undefined) deviceData[deviceId].cpu_usage = deviceInfo.cpu_usage;
                    if (deviceInfo.ram_usage !== undefined) deviceData[deviceId].ram_usage = deviceInfo.ram_usage;
                    if (deviceInfo.memory_percent !== undefined) deviceData[deviceId].memory_percent = deviceInfo.memory_percent;
                    if (deviceInfo.disk_percent !== undefined) deviceData[deviceId].disk_percent = deviceInfo.disk_percent;
                    if (detectionLabel) deviceData[deviceId].detection_label = detectionLabel;
                }
                
                // Update speed chart if speed is available
                if (speed !== undefined && timestamp) {
                    updateChart(deviceId, speed, timestamp);
                }
                
                // Update telemetry display
                updateTelemetry(deviceId, deviceInfo);
                
                // Update detection label
                if (detectionLabel) {
                    updateDetection(deviceId, detectionLabel);
                }
                
                // Update device status
                updateDeviceStatus(deviceId, 'online');
            });
            
            updateStatusBar();
            updateDataTable();
        });

        // Fetch device status periodically
        async function fetchDeviceStatus() {
            try {
                const response = await fetch('/api/devices/status');
                const statuses = await response.json();
                
                Object.keys(statuses).forEach(deviceId => {
                    updateDeviceStatus(deviceId, statuses[deviceId].status);
                });
                
                updateStatusBar();
                updateDataTable();
            } catch (error) {
                console.error('Error fetching device status:', error);
            }
        }

        // Initialize on page load
        initializeCharts();
        
        // Fetch device status every 5 seconds
        setInterval(fetchDeviceStatus, 5000);
        fetchDeviceStatus();
        
        // Update table every second
        setInterval(updateDataTable, 1000);
    </script>
</body>
</html>

